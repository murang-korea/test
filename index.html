<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>1초 판단</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #000; --fg: #fff; --accent: #fff; }
        body { margin: 0; background: var(--bg); color: var(--fg); font-family: sans-serif; overflow: hidden; touch-action: none; user-select: none; }
        
        /* 메인 오버레이 */
        #overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; background: var(--bg); transition: 0.5s; }
        #overlay.hidden { opacity: 0; pointer-events: none; }
        .title { font-size: 3rem; font-weight: 900; letter-spacing: -2px; }
        .ranking { width: 250px; margin: 20px 0; font-size: 0.9rem; color: #666; }
        .rank-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #222; }
        .prompt { margin-top: 30px; animation: blink 1s infinite; font-weight: bold; }

        /* 게임 UI */
        #ui { position: absolute; top: env(safe-area-inset-top, 20px); left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 25px; box-sizing: border-box; font-size: 1.2rem; font-weight: 900; opacity: 0.4; pointer-events: none; z-index: 10; }
        #feedback { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: 900; font-style: italic; pointer-events: none; z-index: 5; }
        
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
        canvas { display: block; }
    </style>
</head>
<body>
    <div id="overlay">
        <div class="title">1초 판단</div>
        <div class="ranking" id="rank-list">로딩 중...</div>
        <div class="prompt">TAP TO START</div>
        <button id="install-btn" style="display:none; margin-top: 20px; padding: 10px 20px; font-size: 1rem; background: #333; color: #fff; border: 1px solid #fff; border-radius: 5px; cursor: pointer;">앱 설치하기</button>
    </div>

    <div id="ui">
        <div id="cur-score">0</div>
        <div>BEST <span id="best-score">0</span></div>
    </div>
    <div id="feedback"></div>
    <canvas id="canvas"></canvas>

    <script>
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let w, h, score = 0, best = localStorage.getItem('best') || 0;
        let state = 'MAIN', particles = [], shake = 0, audio = null, wakeLock = null;

        // 게임 상태 관리
        let appearT = 0, targetT = 0, duration = 0, timer = null;

        async function init() {
            resize();
            window.addEventListener('resize', resize);
            document.getElementById('best-score').innerText = best;
            loadRankings();

            const start = async () => {
                if (state !== 'MAIN') return;
                state = 'IDLE';
                document.getElementById('overlay').classList.add('hidden');
                document.getElementById('ui').style.display = 'flex';
                try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
                startRound();
            };

            document.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(); start(); }, { passive: false });
            document.addEventListener('mousedown', () => { handleInput(); start(); });
            animate();
        }

        function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }

        async function loadRankings() {
            if (!supabase) return;
            const { data } = await supabase.from('rankings').select('name, score').order('score', { ascending: false }).limit(5);
            if (data) document.getElementById('rank-list').innerHTML = data.map((r, i) => `<div class="rank-item"><span>${i+1}. ${r.name}</span><span>${r.score}</span></div>`).join('');
        }

        function startRound() {
            state = 'WAIT';
            timer = setTimeout(() => {
                state = 'ACTIVE';
                appearT = Date.now();
                duration = Math.random() * 1200 + 400;
                targetT = appearT + duration;
                timer = setTimeout(() => { if (state === 'ACTIVE') endRound('MISS'); }, duration);
            }, Math.random() * 1000 + 500);
        }

        function handleInput() {
            if (state === 'WAIT') { clearTimeout(timer); endRound('EARLY'); }
            else if (state === 'ACTIVE') {
                clearTimeout(timer);
                const diff = targetT - Date.now();
                endRound(diff <= 120 && diff >= 0 ? 'PERFECT' : 'EARLY');
            }
        }

        function endRound(res) {
            if (res === 'PERFECT') {
                score += 10;
                showFeedback('PERFECT!');
                vibrate([40, 20]); playSfx(880, 0.1);
                for(let i=0; i<20; i++) particles.push(new Particle(w/2, h/2));
                shake = 10; state = 'STOP';
                setTimeout(startRound, 100);
            } else {
                if (res === 'EARLY') { score += 2; playSfx(330, 0.05); vibrate(10); }
                showFeedback(''); startRound();
            }
            if (score > best) { best = score; localStorage.setItem('best', best); updateBest(); }
            document.getElementById('cur-score').innerText = score;
        }

        function updateBest() {
            document.getElementById('best-score').innerText = best;
            if (supabase) {
                const name = localStorage.getItem('nickname') || '익명';
                supabase.from('rankings').upsert({ name, score: best }, { onConflict: 'name' }).then();
            }
        }

        function showFeedback(txt) { document.getElementById('feedback').innerText = txt; }
        function vibrate(p) { if (navigator.vibrate) navigator.vibrate(p); }
        function playSfx(f, d) {
            if (!audio) audio = new (window.AudioContext || window.webkitAudioContext)();
            const o = audio.createOscillator(), g = audio.createGain();
            o.connect(g); g.connect(audio.destination);
            o.frequency.setValueAtTime(f, audio.currentTime);
            g.gain.setValueAtTime(0.1, audio.currentTime); g.gain.linearRampToValueAtTime(0, audio.currentTime + d);
            o.start(); o.stop(audio.currentTime + d);
        }

        class Particle {
            constructor(x, y) { this.x = x; this.y = y; this.vx = (Math.random()-0.5)*20; this.vy = (Math.random()-0.5)*20; this.a = 1; }
            update() { this.x += this.vx; this.y += this.vy; this.a -= 0.03; }
            draw() { ctx.fillStyle = `rgba(255,255,255,${this.a})`; ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fill(); }
        }

        function animate() {
            ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(0,0,w,h);
            if (shake > 0) { ctx.save(); ctx.translate((Math.random()-0.5)*15, (Math.random()-0.5)*15); shake--; }
            particles = particles.filter(p => p.a > 0); particles.forEach(p => { p.update(); p.draw(); });
            if (state === 'ACTIVE') {
                const p = (Date.now() - appearT) / duration;
                ctx.beginPath(); ctx.arc(w/2, h/2, 70, 0, Math.PI*2); ctx.fillStyle = '#fff'; ctx.fill();
                ctx.beginPath(); ctx.arc(w/2, h/2, 85, -Math.PI/2, -Math.PI/2 + Math.PI*2*(1-p)); ctx.strokeStyle = '#fff'; ctx.lineWidth = 5; ctx.stroke();
            } else if (state === 'STOP') { ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h); }
            if (shake >= 0) ctx.restore();
            requestAnimationFrame(animate);
        }

        window.onload = init;

        // PWA 설치 로직
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBtn.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        window.addEventListener('appinstalled', () => {
             installBtn.style.display = 'none';
        });

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>
